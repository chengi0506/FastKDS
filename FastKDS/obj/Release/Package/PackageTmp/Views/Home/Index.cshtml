
@model IEnumerable<FastKDS.Models.Orders>

@{
    Layout = null;
    string DeveloperNname = "財團法人農漁會南區資訊中心";
    string SystemName = "KDS廚房控菜系統";
}


<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/dist/img/fastlogo.ico" type="image/x-icon">
    <link href="~/dist/css/adminlte.min.css" rel="stylesheet" />
    <link href="~/dist/css/bs-stepper.min.css" rel="stylesheet" />
    <link href="~/plugins/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
    <title>@DeveloperNname @SystemName</title>
    <link href="~/dist/myStyle.css" rel="stylesheet" />
    <link href="~/plugins/fontawesome-free/css/all.min.css" rel="stylesheet" />
</head>
<body class="hold-transition layout-top-nav">
    <div class="wrapper">

        <nav class="main-header navbar navbar-expand-md navbar-light navbar-white fixed-top">
            <div class="container">
                <a href="../../index3.html" class="navbar-brand">
                    <img src="../../dist/img/fast.png" alt="Fast Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
                    <span class="brand-text font-weight-light"><b>@DeveloperNname@SystemName</b></span>
                </a>
                <button class="navbar-toggler order-1" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </nav>


        <div class="content-wrapper">
            <div class="content-header">
                <div class="container">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0"></h1>
                        </div>
                        <div class="col-sm-6">
                            @*<ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item active">PAGE1</li>
                                <li class="breadcrumb-item"><a href="#">PAGE2</a></li>
                                <li class="breadcrumb-item"><a href="#">PAGE3</a></li>
                            </ol>*@
                        </div>
                    </div>
                </div>
            </div>

            <div class="content" style="padding-top:50px;">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="container">
                                        <div class="row row-cols-md-12">
                                            <div class="col-md-6">
                                                <h5 class="card-title m-0"><span id="current-time"></span> 廚房訂單</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">

                                    <div id="MsgDiv" class="callout callout-danger" style="display: none;">
                                        <i class="fas fa-bullhorn"></i>
                                        <p id="Msg">
                                            訂單通知
                                        </p>
                                    </div>

                                    <div class="card">
                                        <div class="card-header p-2">
                                            <ul class="nav nav-pills">
                                                <li class="nav-item"><a class="nav-link active" href="#tab1" data-toggle="tab"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;" id="flag1">全部訂單</font></font></a></li>
                                                <li class="nav-item"><a class="nav-link" href="#tab2" data-toggle="tab"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;" id="flag2">新訂單</font></font></a></li>
                                                <li class="nav-item"><a class="nav-link" href="#tab3" data-toggle="tab"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;" id="flag3">製作中</font></font></a></li>
                                                <li class="nav-item"><a class="nav-link" href="#tab4" data-toggle="tab"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;" id="flag4">待取餐</font></font></a></li>
                                                <li class="nav-item"><a class="nav-link" href="#tab5" data-toggle="tab"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;" id="flag5">已完成</font></font></a></li>
                                            </ul>
                                        </div>
                                        <div class="card-body">
                                            <div class="tab-content">
                                                <div class="tab-pane active" id="tab1">
                                                    <div class="container">
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="table-responsive">
                                                                    <table id="orderTable" class="table table-bordered table-hover">
                                                                        <thead>
                                                                            <tr>
                                                                                <th style="width: 47%;">狀態</th>
                                                                                <th style="width: 30%;">明細</th>
                                                                                <th style="width: 8%;">備註</th>
                                                                                <th style="width: 15%;"></th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody id="list1">
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="tab-pane" id="tab2">
                                                    <div class="container">
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="table-responsive">
                                                                    <table id="orderTable" class="table table-bordered table-hover">
                                                                        <thead>
                                                                            <tr>
                                                                                <th style="width: 47%;">狀態</th>
                                                                                <th style="width: 30%;">明細</th>
                                                                                <th style="width: 8%;">備註</th>
                                                                                <th style="width: 15%;"></th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody id="list2">
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="tab-pane" id="tab3">
                                                    <div class="container">
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="table-responsive">
                                                                    <table id="orderTable" class="table table-bordered table-hover">
                                                                        <thead>
                                                                            <tr>
                                                                                <th style="width: 47%;">狀態</th>
                                                                                <th style="width: 30%;">明細</th>
                                                                                <th style="width: 8%;">備註</th>
                                                                                <th style="width: 15%;"></th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody id="list3">
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="tab-pane" id="tab4">
                                                    <div class="container">
                                                        <div class="col-md-12">
                                                            <div class="table-responsive">
                                                                <table id="orderTable" class="table table-bordered table-hover">
                                                                    <thead>
                                                                        <tr>
                                                                            <th style="width: 47%;">狀態</th>
                                                                            <th style="width: 30%;">明細</th>
                                                                            <th style="width: 8%;">備註</th>
                                                                            <th style="width: 15%;"></th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="list4">
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="tab-pane" id="tab5">
                                                    <div class="container">
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="table-responsive">
                                                                    <table id="orderTable" class="table table-bordered table-hover">
                                                                        <thead>
                                                                            <tr>
                                                                                <th style="width: 47%;">狀態</th>
                                                                                <th style="width: 30%;">明細</th>
                                                                                <th style="width: 8%;">備註</th>
                                                                                <th style="width: 15%;"></th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody id="list5">
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="loading" style="align-content:center"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-danger btn-floating btn-lg" id="btn-back-to-top">
            <i class="fas fa-arrow-up"></i>
        </button>

        <aside class="control-sidebar control-sidebar-dark">
        </aside>

        <footer class="main-footer">
            <strong><a href="https://www.fast.org.tw/">本系統由{@DeveloperNname}設計維護</a></strong>
        </footer>
    </div>

    <script src="~/Scripts/jquery.min.js"></script>
    <script src="~/dist/js/adminlte.min.js"></script>
    <script src="~/dist/js/bs-stepper.min.js"></script>
    <script src="~/dist/js/demo.js"></script>
    <!-- jQuery -->
    <script src="~/plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="~/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="~/dist/js/adminlte.min.js"></script>
    <!-- AdminLTE for demo purposes -->
    <!--<script src="~/dist/js/demo.js"></script>-->
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--sweetalert2 script-->
    <script src="~/plugins/sweetalert2/sweetalert2.all.min.js"></script>

    <script>
        $(function () {
            $.ajax({
                    url: "/api/Order/getAllOrders",
                    type: 'GET',
                success: function (data) {
                        innerHtml(data);
                    },
                    error: function () {
                        alert('無法取得訂單');
                    }
                });

            var chat = $.connection.ChatHub;

            chat.client.addNewMessageToPage = function (data) {
                innerHtml(data);
            };

            $.connection.hub.start().done(function () {
            });
        });

       function updateOrderStatus(orderId, currentState) {
                $.ajax({
                    //url: '@Url.Action("UpdateOrderStatus", "Home")',
                    url: "/api/Order/UpdateOrderStatus",
                    type: 'GET',
                    data: { orderId: orderId, currentState: currentState },
                    success: function (data) {
                        //innerHtml(data);
                    },
                    error: function () {
                        alert('無法更新訂單狀態');
                    }
                });
        }

        var audio = new Audio('@Url.Content("~/Sound/pikachu.mp3")');

        function playAudio() {
            // 對於某些瀏覽器，需要在用戶交互之後播放音頻
            audio.play().then(() => {
                // 音頻播放成功
                console.info('音頻播放成功');
            }).catch((error) => {
                // 音頻播放失敗，可能是因為用戶未進行交互
                console.error('播放失敗:', error.message);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 判斷是否已經詢問過用戶
            //var hasAskedPermission = localStorage.getItem('audioPermissionAsked');

            //if (!hasAskedPermission) {
                // 未詢問過，彈出確認訊息
                Swal.fire({
                    title: '確認訊息',
                    text: '新訂單播放音效?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '是',
                    cancelButtonText: '否'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // 用戶同意，設定標記並播放音頻
                        localStorage.setItem('audioPermissionAsked', 'true');
                        playAudio();
                    } else {
                        // 用戶拒絕，可以進行相應處理
                    }
                });
            //}

            var playButton = document.getElementById('playButton');

            playButton.addEventListener('click', function () {
                playAudio();
            });
        });

        function innerHtml(data) {
            console.log("innerHtml");
            var d = data.split("||");
            if (d.length > 1) {
                $("#list1").html(d[0]);
                $("#list2").html(d[1]);
                $("#list3").html(d[2]);
                $("#list4").html(d[3]);
                $("#list5").html(d[4]);

                // 解析統計信息
                var stats = JSON.parse(d[5]);

                // 顯示訂單筆數統計
                $("#flag1").text(`全部訂單(${stats.AllOrdersCount})`);
                $("#flag2").text(`新訂單(${stats.NewOrdersCount})`);
                $("#flag3").text(`製作中(${stats.InProgressOrdersCount})`);
                $("#flag4").text(`待取餐(${stats.WaitingForPickupOrdersCount})`);
                $("#flag5").text(`已完成(${stats.CompletedOrdersCount})`);

                console.log(d.length );
                if (d.length > 7) {
                    //initAudioContext();
                    showMessage(d[6], d[7].replace(/\n/g, "<br>"));
                    console.log("printOrder" + d[8]);
                    printOrder(d[8]);

                    playAudio();
                }
            }
        }

        function initAudioContext() {
        // 創建 AudioContext 或 webkitAudioContext
        var context = new (window.AudioContext || window.webkitAudioContext)();

        console.log(context.state);

        showMessage(context.state);

        // 繼續 AudioContext
        if (context.state === 'suspended') {
            context.resume().then(() => {
                console.log('AudioContext resumed');
                playNotificationSound(context);
            });
        } else {
            console.log('AudioContext');
            playNotificationSound(context);
        }
    }

    function playNotificationSound(context) {
        var source = context.createBufferSource();

        // 獲取 Web 根目錄下的文件路徑
        var soundFilePath = '@Url.Content("~/Sound/pikachu.mp3")';

        // 加載音訊文件，然後播放
        fetch(soundFilePath)
            .then(response => response.arrayBuffer())
            .then(data => context.decodeAudioData(data))
            .then(buffer => {
                source.buffer = buffer;
                source.connect(context.destination);
                source.start(0);
            })
            .catch(error => console.error(error));
     }

        function showMessage(title,msg) {
            $("#MsgDiv").show();
            $("#Msg").text(title);

            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: title,
                html: msg,
                showConfirmButton: false,
                timer: 1500
            })
        }

        function CreateNewOrder() {
                $.ajax({
                    url: "/api/Order",
                    type: 'GET',
                    success: function (data) {
                        location.reload();
                    },
                    error: function () {
                        alert('無法更新訂單狀態。');
                    }
                });
        }

        function printOrder(orderId) {
            $.ajax({
                url: "/api/Order/PrintOrder",
                type: 'GET',
                data: { orderId: orderId },
                success: function (data) {
                    console.log(data);
                    }
                });
        }

        // 函數來獲取格式化後的當前時間
        function getCurrentTime() {
            var now = new Date();
            var year = now.getFullYear();
            var month = (now.getMonth() + 1).toString().padStart(2, '0');
            var day = now.getDate().toString().padStart(2, '0');
            var hours = now.getHours().toString().padStart(2, '0');
            var minutes = now.getMinutes().toString().padStart(2, '0');
            var seconds = now.getSeconds().toString().padStart(2, '0');

            return year + '年' + month + '月' + day + '日 ' + hours + ':' + minutes + ':' + seconds;
        }

        // 函數來更新時間元素的內容
        function updateCurrentTime() {
            var currentTimeElement = document.getElementById('current-time');
            if (currentTimeElement) {
                currentTimeElement.textContent = getCurrentTime();
            }
        }

        // 定期更新時間，例如每秒更新一次
        setInterval(updateCurrentTime, 1000);

        // 初始頁面時更新時間
        updateCurrentTime();

        //Get the button
        let mybutton = document.getElementById("btn-back-to-top");

        // When the user scrolls down 20px from the top of the document, show the button
        window.onscroll = function () {
            scrollFunction();
        };

        function scrollFunction() {
            if (
                document.body.scrollTop > 20 ||
                document.documentElement.scrollTop > 20
            ) {
                mybutton.style.display = "block";
            } else {
                mybutton.style.display = "none";
            }
        }
        // When the user clicks on the button, scroll to the top of the document
        mybutton.addEventListener("click", backToTop);

        function backToTop() {
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }

        //$(function () {
        //    //引用為該Hub自動生成的代理
        //    var chat = $.connection.ChatHub;
        //    //創建一個用於 Hub 回呼以顯示消息的函數
        //    chat.client.addNewMessageToPage = function (data) {
        //        // 顯示訊息
        //        $("#MsgDiv").show();

        //        // 清除文本内容
        //        $("#Msg").text("");

        //        //var parts = message.split('-----------------------');
        //        //if (parts.length > 1) {
        //        //    var extractedText = parts[0].trim();
        //        //    console.log(extractedText);
        //        //    //在頁面上添加消息
        //        //    $('#Msg').append('<strong>' + extractedText + '</strong>');
        //        //}

        //        //Swal.fire({
        //        //    toast: true,
        //        //    position: 'top-end',
        //        //    icon: 'success',
        //        //    title: name,
        //        //    html: message.replace(/\n/g, "<br>"),
        //        //    showConfirmButton: false,
        //        //    timer: 1500
        //        //})


        //        // 在成功回調函數中處理返回的訂單數據
        //        //updateOrderStepperHeader(data.LatestOrder, data.LatestOrderDetail);

        //        // 取得 bs-stepper-header 的 jQuery 物件
        //        var stepperHeader = $('#orderStepperHeader');

        //        // 清空原有的訂單項目
        //        stepperHeader.empty();

        //        // 迭代處理每一個訂單
        //        $.each(data, function (index, order) {
        //            // 創建一個新的行元素
        //            var row = $('<tr></tr>');

        //            // 創建 bs-stepper 元素
        //            var stepper = $('<div class="bs-stepper linear"></div>');

        //            // 創建 bs-stepper-header 元素
        //            var stepperHeader = $('<div class="bs-stepper-header" role="tablist"></div>');

        //            // 迭代處理每一個步驟
        //            for (var step = 1; step <= 4; step++) {
        //                // 創建步驟元素
        //                var stepElement = $('<div class="step" data-target="#step' + step + '"></div>');

        //                // 添加步驟內容
        //                stepElement.append('<button type="button" class="step-trigger" role="tab" aria-controls="step' + step + '">' +
        //                    '<span class="bs-stepper-circle">' + step + '</span>' +
        //                    '<span class="bs-stepper-label">' + getStepLabel(order, step) + '</span>' +
        //                    '<span class="bs-stepper-label">' + getDateTime(order, step) + '</span>' +
        //                    '</button>');

        //                // 將步驟元素添加到 bs-stepper-header
        //                stepperHeader.append(stepElement);

        //                // 如果不是最後一個步驟，添加分隔線
        //                if (step !== 4) {
        //                    stepperHeader.append('<div class="line"></div>');
        //                }
        //            }

        //            // 將 bs-stepper-header 添加到 bs-stepper
        //            stepper.append(stepperHeader);

        //            // 將 bs-stepper 添加到行元素
        //            row.append($('<td></td>').append(stepper));

        //            // 添加其他訂單信息到行元素
        //            row.append('<td>' + order.OrderID + '</td>');
        //            row.append('<td><ul>...</ul></td>'); // 這裡需要添加訂單明細的代碼
        //            row.append('<td>' + order.Note + '</td>');
        //            row.append('<td><button class="btn btn-danger" onclick="updateOrderStatus(' + order.OrderID + ', \'' + order.State + '\')">下一步</button></td>');

        //            // 將行元素添加到 #orderStepperHeader
        //            stepperHeader.append(row);
        //        });


        //    };
        //    //獲取用戶名並存儲以便添加到消息前面
        //    //$('#displayname').val(prompt('Enter your name:', ''));
        //    //將焦點初始化設置在消息輸入框上
        //    //$('#message').focus();
        //    //啟動連接
        //    $.connection.hub.start().done(function () {
        //        //$('#sendmessage').click(function () {
        //        //    //調用 Hub 上的 Send 方法
        //        //    chat.server.send($('#displayname').val(), $('#message').val());
        //        //    //清空文本框並為下一條評論重置焦點
        //        //    $('#message').val('').focus();
        //        //});
        //    });
        //});
    </script>

</body>
</html>
